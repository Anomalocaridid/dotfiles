#!/usr/bin/env bash

# .config/yadm/bootstrap
# Bootstrap script intended to automate setting up a new hyper-personalized system
# WARNING: Only tested with EndeavourOS. May still work with other Arch derivatives, but NOT guaranteed.

# Dependencies for my setup for various programs
# Intended to be redundant so I don't have to consider if other programs
# already rely on something before adding or removing it.

# Initialize submodules
yadm submodule update --recursive --init

# Dependencies for zsh config
readonly zsh_deps=(
	"bat"
	"bat-extras-git"
	# "dust" # Has to be installed after rustup is configured.
	"exa"
	"fd"
	"fzf"
	"lolcat"
	"otf-nerd-fonts-fira-code"
	"pkgfile"
	"ripgrep" # Required by bat-extras-git
	"ranger"
	"toilet"
	"toilet-fonts" # Required by toilet
	"wezterm"
	# "zoxide" # Has to be installed after rustup is configured.
	"zsh"
)

readonly python_dev=(
	"flake8"
	"python"
	"python-language-server"
	"yapf"
)

readonly haskell_dev=(
	"cabal-install"
	"ghc"
	"haskell-language-server"
	"haskell-ormolu"
	"hlint"
	"stack"
)

readonly bash_dev=(
	"shellcheck"
	"shfmt"
)

readonly common_lisp_dev=(
	"clisp"
	"sbcl"
)

# Dependencies for Kakoune setup
readonly kak_deps=(
	"${bash_dev[@]}"
	"${common_lisp_dev[@]}"
	"${haskell_dev[@]}"
	"${python_dev[@]}"
	"clang" # For C development
	"fzf"
	"kakoune"
	"rustup" # For Rust development
)

# Miscellanious programs that I frequently use
readonly misc=(
	"betterdiscord-installer"
	"breeze-hacked-cursor-theme"
	"discord"
	"gdlauncher-bin"
	"gnuplot" # Required by qalculate-gtk
	"itch"
	"joplin-desktop"
	"keepassxc"
	"lutris"
	"megasync-bin"
	"moreutils"
	"qalculate-gtk"
	"steam"
	"strawberry"
	"syncthing"
	"syncthingtray"
	# "tealdeer" # Has to be installed after rustup is configured.
	"waterfox-g3-bin"
	"wine"
	"wine-gecko"
	"wine-mono"
	"yubioath-desktop"
)

# Install programs with yay
yay -Syu --needed $(echo "${zsh_deps[*]} ${kak_deps[*]} ${misc[*]}" | sort | uniq)

# Configure rustup
if rustup default stable; then
	if rustup component add rls rust-analysis rust-src; then
		echo "Successfully configured rustup"
	else
		echo "Could not configure rustup"
	fi
else
	echo "Could not configure rustup"
fi

# Install packages that require rustup
yay -S --needed dust zoxide tealdeer

# Switch user's default shell to zsh
if chsh -s "$(which zsh)"; then
	echo "Successfully set $USER's shell to zsh"
else
	echo "Could not set $USER's shell to zsh"
fi

# Enable important services
readonly services=(
	"pcscd"
	"pkgfile-update.timer"
)

for service in "${services[@]}"; do
	if sudo systemctl enable "$service"; then
		echo "Successfully enabled service: $service"
	else
		echo "Could not enable service: $service"
	fi
done

# Update pkgfile cache
if sudo pkgfile --update; then
	echo "Successfully updated pkgfile cache"
else
	echo "Could not update pkgfile cache"
fi

# Update tldr cache
if tldr --update; then
	echo "Successfully updated tldr cache"
else
	echo "Could not update tldr cache"
fi

# Build bat theme cache
if bat cache --build; then
	echo "Successfully built bat cache"
else
	echo "Could not build bat cache"
fi

# Initialize QMK
readonly qmk_repo="https://github.com/anomalocaridid/qmk_firmware.git"
git clone "$qmk_repo"
python3 -m pip install --user qmk
PATH=$PATH:"$HOME/.local/bin"
sudo cp "$HOME/qmk_firmware/util/udev/50-qmk.rules" /etc/udev/rules.d
qmk setup

# Add avr-gcc to IgnorePkg in pacman.conf, as qmk only works with a certain version
sudo sed -i "/^#IgnorePkg/ {s/$/ avr-gcc/; s/^#//}" /etc/pacman.conf

# TODO: Configure QEMU

# Set cursor theme in default theme
readonly default_cursor_theme="/usr/share/icons/default/index.theme"

if sudo sed -i "s/Adwaita/Breeze_Hacked/" "$default_cursor_theme"; then
	echo "Successfully set cursor in $default_cursor_theme"
else
	echo "Could not set cursor in $default_cursor_theme"
fi

# Download color scheme to KDE system theme directory
readonly color_scheme_url="https://raw.githubusercontent.com/Roboron3042/Cyberpunk-Neon/master/kde/cyberpunk-neon.colors"
readonly color_scheme_dir="/usr/share/color-schemes/"

if mkdir -p "$color_scheme_dir"; then
	if sudo wget "$color_scheme_url" --output-document="$color_scheme_dir/cyberpunk-neon.colors"; then
		echo "Successfully downloaded KDE color scheme"
	else
		echo "Could not download KDE color scheme"
	fi
else
	echo "Could not create folder at $color_scheme_dir"
fi

# Install and configure icon theme
readonly icon_theme_url="https://raw.githubusercontent.com/gusbemacbe/suru-plus-aspromauros/master/install.sh"
readonly icon_themes_dir="/usr/share/icons"

if wget -qO- "$icon_theme_url" | sh; then
	echo "Successfully installed icon theme"

	if sudo mv "$icon_themes_dir/Suru++-Aspr√≥mauros" "$icon_themes_dir/Suru++"; then
		echo "Successfully renamed icon theme folder"

		if sudo wget https://git.io/fhbxw --output-document="/usr/local/bin/suru-plus-colourise"; then
			if sudo chmod a+x /usr/local/bin/suru-plus-colourise; then
				echo "Successfully installed suru-plus-colourise"
				sudo suru-plus-colourise
			else
				echo "Could not install suru-plus-colourise"
			fi
		else
			echo "Could not install suru-plus-colourise"
		fi
	else
		echo "Could not rename icon theme folder"
	fi
else
	echo "Could not install icon theme"
fi

# Install GRUB theme
readonly grub_theme_url="https://dllb2.pling.com/api/files/download/j/eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpZCI6IjE1OTk3MTQ4MDIiLCJ1IjpudWxsLCJsdCI6ImRvd25sb2FkIiwicyI6IjkwOTQ3ZDM0OThmNThlYzkwODY5YjBmMDI1NGJkMzA5N2UzM2M4YWMwMzc0Yjg5ZWFmOWMzNDBhMjM0ZjNlOTI2NzNkYjZlZDFkNjhhOTgwODAyZDA5N2Q2YTliZWE1NWYyMDE5ZjBiNDUzNzk1YmQyMWIxNWYwNTFiNDczY2UyIiwidCI6MTYyMzA5ODAyMSwic3RmcCI6ImViNGI1MzFmZGM5MzFhMjVkYWVhNTUwZjQ3ODUwZTA1Iiwic3RpcCI6IjcyLjI0MC4xNDQuMTk3In0.7K4PL37eBj08nrnQSFxZztW5nATH3Rbd7HDvK9NvATg/Grub2-theme%20CyberRe%201.0.0.tar.gz"

readonly grub_theme_file="/tmp/CyberRe.tar.gz"
wget "$grub_theme_url" --output-document "$grub_theme_file"
tar xf "$grub_theme_file" --directory=/tmp
cd "/tmp/CyberRe 1.0.0"
./install.sh
cd

# TODO: Prompt instructions for remaining manual setup
# Set Default Programs
# Set color scheme
# Set icon theme
# Configure syncs
